<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data>
        <!-- Template for sidebar button in sale_order_portal_template -->
        <template id="sale_order_portal_template_stripe" inherit_id="sale.sale_order_portal_template" name="Sale Order Portal Template - Stripe">
            <!-- Add Stripe Pay Now button in sidebar - target through t-set block -->
            <xpath expr="//t[@t-set='entries']//div[@id='sale_order_sidebar_button']" position="inside">
                <a t-if="sale_order.stripe_payment_link_url and sale_order._has_to_be_paid() and not sale_order._has_to_be_signed()" 
                   role="button" 
                   id="o_sale_portal_paynow_stripe" 
                   t-att-href="sale_order.stripe_payment_link_url" 
                   target="_blank"
                   t-att-class="'%s' % ('btn btn-light' if sale_order.transaction_ids else 'btn btn-primary')">
                    <i class="fa fa-check"/> <t t-if="not sale_order.signature">Accept &amp; Pay</t><t t-else="">Pay Now</t>
                </a>
            </xpath>
            
            <!-- Modify original Pay Now button to exclude Stripe link cases -->
            <xpath expr="//t[@t-set='entries']//div[@id='sale_order_sidebar_button']/a[@id='o_sale_portal_paynow']" position="attributes">
                <attribute name="t-if">not sale_order.stripe_payment_link_url and sale_order._has_to_be_paid()</attribute>
            </xpath>
        </template>
        
        <!-- Template for bottom button in sale_order_portal_content -->
        <template id="sale_order_portal_content_stripe" inherit_id="sale.sale_order_portal_content" name="Sale Order Portal Content - Stripe">
            <!-- Add our Stripe button inside sale_order_actions, before the existing buttons -->
            <xpath expr="//div[@name='sale_order_actions']" position="inside">
                <div t-if="sale_order.stripe_payment_link_url and sale_order._has_to_be_paid() and not sale_order._has_to_be_signed()" class="col-sm-auto mt8">
                    <a role="button" 
                       t-att-href="sale_order.stripe_payment_link_url" 
                       target="_blank"
                       t-att-class="'%s' % ('btn btn-light' if sale_order.transaction_ids else 'btn btn-primary')">
                        <i class="fa fa-check"/> <t t-if="not sale_order.signature">Accept &amp; Pay</t><t t-else="">Pay Now</t>
                    </a>
                </div>
            </xpath>
            
            <!-- Hide the original Pay Now button when Stripe link exists -->
            <xpath expr="//div[@name='sale_order_actions']//a[@data-bs-target='#modalaccept']" position="attributes">
                <attribute name="t-if">not sale_order.stripe_payment_link_url or sale_order._has_to_be_signed()</attribute>
            </xpath>
        </template>
    </data>
</odoo>
