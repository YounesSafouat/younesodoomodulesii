<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data>
        <template id="sale_order_portal_content_stripe" inherit_id="sale.sale_order_portal_content" name="Sale Order Portal Content - Stripe">
            <!-- Replace the entire button section in sidebar to add Stripe support -->
            <xpath expr="//div[@id='sale_order_sidebar_button']" position="replace">
                <div class="d-flex flex-column gap-2" id="sale_order_sidebar_button">
                    <a t-if="sale_order._has_to_be_signed()" role="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalaccept" href="#">
                        <i class="fa fa-check"/><t t-if="sale_order._has_to_be_paid()"> Sign &amp; Pay</t><t t-else=""> Accept &amp; Sign</t>
                    </a>
                    <a t-elif="sale_order.stripe_payment_link_url and sale_order._has_to_be_paid()" 
                       role="button" 
                       id="o_sale_portal_paynow" 
                       t-att-href="sale_order.stripe_payment_link_url" 
                       target="_blank"
                       t-att-class="'%s' % ('btn btn-light' if sale_order.transaction_ids else 'btn btn-primary')">
                        <i class="fa fa-check"/> <t t-if="not sale_order.signature">Accept &amp; Pay</t><t t-else="">Pay Now</t>
                    </a>
                    <a t-elif="sale_order._has_to_be_paid()" 
                       role="button" 
                       id="o_sale_portal_paynow" 
                       data-bs-toggle="modal" 
                       data-bs-target="#modalaccept" 
                       href="#" 
                       t-att-class="'%s' % ('btn btn-light' if sale_order.transaction_ids else 'btn btn-primary')">
                        <i class="fa fa-check"/> <t t-if="not sale_order.signature">Accept &amp; Pay</t><t t-else="">Pay Now</t>
                    </a>
                    <div class="o_download_pdf d-flex gap-2 flex-lg-column flex-xl-row flex-wrap">
                        <a class="btn btn-light o_print_btn o_portal_invoice_print flex-grow-1" t-att-href="sale_order.get_portal_url(report_type='pdf')" id="print_invoice_report" title="View Details" role="button" target="_blank"><i class="fa fa-print me-1"/>View Details</a>
                    </div>
                </div>
            </xpath>
            
            <!-- Replace bottom Pay Now button: use Stripe link if available, otherwise default modal -->
            <xpath expr="//div[@name='sale_order_actions']//div[hasclass('col-sm-auto') and hasclass('mt8')]/a[@data-bs-target='#modalaccept']" position="replace">
                <a t-if="sale_order.stripe_payment_link_url and sale_order._has_to_be_paid() and not sale_order._has_to_be_signed()" 
                   role="button" 
                   t-att-href="sale_order.stripe_payment_link_url" 
                   target="_blank"
                   t-att-class="'%s' % ('btn btn-light' if sale_order.transaction_ids else 'btn btn-primary')">
                    <i class="fa fa-check"/> <t t-if="not sale_order.signature">Accept &amp; Pay</t><t t-else="">Pay Now</t>
                </a>
                <a t-elif="sale_order._has_to_be_paid() and not sale_order._has_to_be_signed()" 
                   role="button" 
                   data-bs-toggle="modal" 
                   data-bs-target="#modalaccept" 
                   href="#" 
                   t-att-class="'%s' % ('btn btn-light' if sale_order.transaction_ids else 'btn btn-primary')">
                    <i class="fa fa-check"/> <t t-if="not sale_order.signature">Accept &amp; Pay</t><t t-else="">Pay Now</t>
                </a>
            </xpath>
        </template>
    </data>
</odoo>
