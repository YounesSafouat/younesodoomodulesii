<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data>
        <!-- Template for sidebar and bottom buttons in sale_order_portal_template -->
        <template id="sale_order_portal_template_stripe" inherit_id="sale.sale_order_portal_template" name="Sale Order Portal Template - Stripe">
            <!-- Add Stripe Pay Now button in sidebar above View Details button -->
            <xpath expr="//t[@t-set='entries']//div[@id='sale_order_sidebar_button']/div[@class='o_download_pdf']" position="before">
                <a t-if="sale_order.stripe_payment_link_url and sale_order._has_to_be_paid() and not sale_order._has_to_be_signed()" 
                   role="button" 
                   id="o_sale_portal_paynow_stripe" 
                   t-att-href="sale_order.stripe_payment_link_url" 
                   target="_blank"
                   class="btn btn-primary w-100 mb-2"
                   t-att-class="'%s' % ('btn btn-light' if sale_order.transaction_ids else 'btn btn-primary')">
                    <i class="fa fa-check"/> <t t-if="not sale_order.signature">Accept &amp; Pay</t><t t-else="">Pay Now</t>
                </a>
            </xpath>
            
            <!-- Replace original Pay Now button (if it exists) to use Stripe link -->
            <xpath expr="//t[@t-set='entries']//div[@id='sale_order_sidebar_button']/a[@id='o_sale_portal_paynow']" position="replace">
                <a t-if="sale_order.stripe_payment_link_url and sale_order._has_to_be_paid() and not sale_order._has_to_be_signed()" 
                   role="button" 
                   id="o_sale_portal_paynow" 
                   t-att-href="sale_order.stripe_payment_link_url" 
                   target="_blank"
                   t-att-class="'%s' % ('btn btn-light' if sale_order.transaction_ids else 'btn btn-primary')">
                    <i class="fa fa-check"/> <t t-if="not sale_order.signature">Accept &amp; Pay</t><t t-else="">Pay Now</t>
                </a>
                <a t-elif="sale_order._has_to_be_paid()" 
                   role="button" 
                   id="o_sale_portal_paynow" 
                   data-bs-toggle="modal" 
                   data-bs-target="#modalaccept" 
                   href="#" 
                   t-att-class="'%s' % ('btn btn-light' if sale_order.transaction_ids else 'btn btn-primary')">
                    <i class="fa fa-check"/> <t t-if="not sale_order.signature">Accept &amp; Pay</t><t t-else="">Pay Now</t>
                </a>
            </xpath>
            
            <!-- Add our Stripe button inside sale_order_actions for bottom button -->
            <xpath expr="//div[@name='sale_order_actions']" position="inside">
                <div t-if="sale_order.stripe_payment_link_url and sale_order._has_to_be_paid() and not sale_order._has_to_be_signed()" class="col-sm-auto mt8">
                    <a role="button" 
                       t-att-href="sale_order.stripe_payment_link_url" 
                       target="_blank"
                       t-att-class="'%s' % ('btn btn-light' if sale_order.transaction_ids else 'btn btn-primary')">
                        <i class="fa fa-check"/> <t t-if="not sale_order.signature">Accept &amp; Pay</t><t t-else="">Pay Now</t>
                    </a>
                </div>
            </xpath>
            
            <!-- Hide the original bottom Pay Now button when Stripe link exists -->
            <xpath expr="//div[@name='sale_order_actions']//a[@data-bs-target='#modalaccept']" position="attributes">
                <attribute name="t-if">not sale_order.stripe_payment_link_url or sale_order._has_to_be_signed()</attribute>
            </xpath>
        </template>
    </data>
</odoo>
