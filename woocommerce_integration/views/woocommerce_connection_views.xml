<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data>
        <record id="view_woocommerce_connection_tree" model="ir.ui.view">
            <field name="name">woocommerce.connection.tree</field>
            <field name="model">woocommerce.connection</field>
            <field name="arch" type="xml">
                <list string="WooCommerce Connections">
                    <field name="name"/>
                    <field name="store_url"/>
                    <field name="api_version"/>
                    <field name="connection_status" widget="badge" 
                           decoration-success="connection_status == 'success'"
                           decoration-danger="connection_status == 'error'"/>
                    <field name="total_products"/>
                    <field name="last_sync"/>
                    <field name="active" widget="boolean_toggle"/>
                </list>
            </field>
        </record>

        <record id="view_woocommerce_connection_form" model="ir.ui.view">
            <field name="name">woocommerce.connection.form</field>
            <field name="model">woocommerce.connection</field>
            <field name="arch" type="xml">
                <form string="WooCommerce Connection">
                    <header>
                        <button name="test_connection" type="object" 
                                string="Test Connection" 
                                class="btn-primary" 
                                invisible="not active"/>
                        <button name="action_import_products" type="object" 
                                string="Import from WooCommerce" 
                                class="btn-success" 
                                invisible="connection_status != 'success' or import_in_progress"
                                confirm="Do you want to import products from WooCommerce? This will open the import wizard."/>
                        <button name="action_stop_import" type="object" 
                                string="Stop Import" 
                                class="btn-danger" 
                                invisible="not import_in_progress"
                                confirm="Do you want to stop the running import? This will cancel the current import process."/>
                        <button name="action_resume_import" type="object" 
                                string="Resume Import" 
                                class="btn-warning" 
                                invisible="not import_in_progress"
                                help="Manually trigger the next batch if the import appears stuck"/>
                        <button name="action_import_odoo_products" type="object" 
                                string="Export to WooCommerce" 
                                class="btn-warning" 
                                invisible="connection_status != 'success'"
                                confirm="Do you want to export Odoo products to WooCommerce? This will open the export wizard."/>
                        <button name="action_import_categories" type="object" 
                                string="Import Categories" 
                                class="btn-secondary" 
                                invisible="connection_status != 'success'"
                                confirm="Do you want to import categories from WooCommerce?"/>
                        <field name="connection_status" widget="statusbar" statusbar_visible="not_tested,success,error"/>
                    </header>
                    <sheet>
                        <div class="oe_button_box" name="button_box">
                            <button name="action_import_products" type="object" 
                                    class="oe_stat_button" icon="fa-download"
                                    invisible="connection_status != 'success'">
                                <div class="o_field_widget o_stat_info">
                                    <span class="o_stat_value"><field name="total_products"/></span>
                                    <span class="o_stat_text">Products</span>
                                </div>
                            </button>
                            <button name="action_create_order_webhook" type="object" 
                                    class="oe_stat_button" icon="fa-link"
                                    invisible="connection_status != 'success'">
                                <div class="o_field_widget o_stat_info">
                                    <span class="o_stat_text">Create Order Webhook</span>
                                </div>
                            </button>
                        </div>

                        <div class="oe_title">
                            <h1>
                                <field name="name" placeholder="Connection Name"/>
                            </h1>
                        </div>

                        <div class="alert alert-info" invisible="not import_in_progress">
                            <h4>
                                <i class="fa fa-spinner fa-spin"/> Import in Progress
                            </h4>
                            <p><field name="import_status"/></p>
                            <p><strong>Progress:</strong> <field name="import_progress" widget="progressbar"/></p>
                            <p><strong>Cron Job Status:</strong> <field name="import_cron_status" readonly="1"/></p>
                        </div>

                        <div class="alert alert-info" role="alert">
                            <h4><i class="fa fa-info-circle"/> Getting Started</h4>
                            <p><strong>Step 1:</strong> Enter your WooCommerce store URL (e.g., https://yourstore.com)</p>
                            <p><strong>Step 2:</strong> Create API credentials in WooCommerce: <strong>WooCommerce → Settings → Advanced → REST API → Add Key</strong></p>
                            <p><strong>Step 3:</strong> Copy the Consumer Key and Consumer Secret and paste them below</p>
                            <p><strong>Step 4:</strong> Click "Test Connection" to verify your settings</p>
                            <p><strong>Step 5:</strong> Once connected, you can import products or export Odoo products to WooCommerce</p>
                        </div>

                        <group>
                            <group>
                                <field name="store_url" placeholder="https://yourstore.com"
                                       help="Enter your WooCommerce store URL. Make sure it includes https:// and does not end with a slash."/>
                                <field name="api_version" 
                                       help="WooCommerce REST API version. Default is v3. Only change if your store uses a different version."/>
                                <field name="active" 
                                       help="Uncheck to temporarily disable this connection without deleting it."/>
                            </group>
                            <group>
                                <field name="consumer_key" password="True"
                                       help="Consumer Key from WooCommerce REST API. Found in: WooCommerce → Settings → Advanced → REST API"/>
                                <field name="consumer_secret" password="True"
                                       help="Consumer Secret from WooCommerce REST API. Keep this secure and never share it."/>
                                <field name="last_sync" readonly="1"
                                       help="Last time this connection was successfully tested or used."/>
                            </group>
                        </group>

                        <div class="alert alert-warning" role="alert">
                            <h4><i class="fa fa-image"/> WordPress Authentication (Optional)</h4>
                            <p>This is only needed if you want to upload product images directly to WordPress Media Library.</p>
                            <p><strong>How to create an Application Password:</strong></p>
                            <ol>
                                <li>Go to your WordPress admin: <strong>Users → Profile</strong></li>
                                <li>Scroll down to <strong>"Application Passwords"</strong> section</li>
                                <li>Enter a name (e.g., "Odoo Integration") and click <strong>"Add New Application Password"</strong></li>
                                <li>Copy the generated password (format: xxxx xxxx xxxx xxxx xxxx xxxx)</li>
                                <li>Paste it in the field below along with your WordPress username</li>
                            </ol>
                            <p><strong>Note:</strong> If you don't set this up, images will be uploaded using Base64 encoding instead.</p>
                        </div>

                        <group string="WordPress Authentication (for Media Upload)">
                            <group>
                                <field name="wp_username" placeholder="admin"
                                       help="Your WordPress admin username"/>
                                <field name="wp_application_password" password="True" placeholder="xxxx xxxx xxxx xxxx xxxx xxxx"
                                       help="Application Password from WordPress (Users → Profile → Application Passwords). Format: xxxx xxxx xxxx xxxx xxxx xxxx"/>
                            </group>
                        </group>

                        <div class="alert alert-info" role="alert">
                            <h4><i class="fa fa-cog"/> Default Settings</h4>
                            <p>These settings will be applied to all products linked to this connection. You can override them for individual products.</p>
                        </div>

                        <group string="Default Settings">
                            <group>
                                <field name="default_sync_direction"
                                       help="Default sync direction for products linked to this connection. Bidirectional means changes sync both ways. You can change this per product in the Inventory module."/>
                                <field name="image_upload_method"
                                       help="How to upload product images: WordPress Media Library (requires WordPress authentication above) or Base64 encoding."/>
                            </group>
                        </group>

                        <notebook>
                            <page string="Connection Status" name="status">
                                <div class="alert alert-info" role="alert">
                                    <h4><i class="fa fa-info-circle"/> Import Log</h4>
                                    <p>This log shows the progress of product imports. The log updates automatically during import operations.</p>
                                    <p><strong>Tip:</strong> Refresh the page to see the latest log entries if they don't appear automatically.</p>
                                </div>
                                <group>
                                    <field name="connection_error" readonly="1" 
                                           invisible="not connection_error"/>
                                    <field name="import_log" readonly="1" 
                                           widget="text" 
                                           placeholder="Import logs will appear here... The log updates automatically during import operations."
                                           options="{'resizable': True}"
                                           nolabel="1"
                                           style="min-height: 300px; font-family: monospace; font-size: 12px;"/>
                                </group>
                            </page>

                            <page string="Products" name="products">
                                <field name="product_ids" readonly="1">
                                    <list>
                                        <field name="wc_product_id"/>
                                        <field name="name"/>
                                        <field name="wc_sku"/>
                                        <field name="odoo_product_id"/>
                                        <field name="sync_status" widget="badge"
                                               decoration-success="sync_status == 'synced'"
                                               decoration-warning="sync_status == 'pending'"
                                               decoration-danger="sync_status == 'error'"/>
                                        <field name="last_sync"/>
                                    </list>
                                </field>
                            </page>

                            <page string="Field Mappings" name="field_mappings">
                                <div class="alert alert-info" role="alert">
                                    <h4><i class="fa fa-exchange"/> Field Mappings</h4>
                                    <p><strong>What are Field Mappings?</strong></p>
                                    <p>Field mappings allow you to synchronize custom fields between WooCommerce and Odoo. For example, you can map a WooCommerce custom field to an Odoo product attribute.</p>
                                    <p><strong>How to use:</strong></p>
                                    <ol>
                                        <li>Click <strong>"Discover Fields"</strong> to automatically find all available fields in your WooCommerce store</li>
                                        <li>Click <strong>"Create Default Mappings"</strong> to set up standard field mappings (name, price, description, etc.)</li>
                                        <li>Click <strong>"Manage Field Mappings"</strong> to create custom mappings or edit existing ones</li>
                                    </ol>
                                    <p><strong>Note:</strong> Default mappings (name, price, SKU, etc.) are handled automatically. You only need custom mappings for additional fields.</p>
                                </div>
                                <div class="row mb16">
                                    <div class="col-12">
                                        <button name="action_view_field_mappings" type="object" 
                                                string="Manage Field Mappings" 
                                                class="btn btn-primary btn-lg me-2"
                                                icon="fa-cogs"
                                                help="Open the field mapping configuration"/>
                                        <button name="action_create_default_mappings" type="object" 
                                                string="Create Default Mappings" 
                                                class="btn btn-secondary btn-lg me-2"
                                                icon="fa-magic"
                                                confirm="This will create default field mappings for this connection. Any existing default mappings will be skipped. Continue?"
                                                help="Automatically create standard field mappings"/>
                                        <button name="action_get_woocommerce_fields" type="object" 
                                                string="Discover Fields" 
                                                class="btn btn-info btn-lg"
                                                icon="fa-refresh"
                                                invisible="connection_status != 'success'"
                                                confirm="This will fetch all available fields from your WooCommerce store, including custom attributes. Continue?"
                                                help="Fetch custom fields and attributes from WooCommerce"/>
                                    </div>
                                </div>
                                <field name="field_mapping_ids" readonly="1">
                                    <list>
                                        <field name="name"/>
                                        <field name="mapping_direction" widget="badge"/>
                                        <field name="wc_field_name"/>
                                        <field name="odoo_field_name"/>
                                        <field name="field_type"/>
                                        <field name="is_active" widget="boolean_toggle"/>
                                    </list>
                                </field>
                            </page>
                        </notebook>
                    </sheet>
                </form>
            </field>
        </record>

        <record id="view_woocommerce_connection_search" model="ir.ui.view">
            <field name="name">woocommerce.connection.search</field>
            <field name="model">woocommerce.connection</field>
            <field name="arch" type="xml">
                <search string="WooCommerce Connections">
                    <field name="name"/>
                    <field name="store_url"/>
                    <field name="consumer_key"/>
                    <filter string="Active" name="active" domain="[('active', '=', True)]"/>
                    <filter string="Connected" name="connected" domain="[('connection_status', '=', 'success')]"/>
                    <filter string="Error" name="error" domain="[('connection_status', '=', 'error')]"/>
                    <separator/>
                    <filter string="Not Tested" name="not_tested" domain="[('connection_status', '=', 'not_tested')]"/>
                    <group expand="0" string="Group By">
                        <filter string="Connection Status" name="group_status" context="{'group_by': 'connection_status'}"/>
                        <filter string="API Version" name="group_api_version" context="{'group_by': 'api_version'}"/>
                    </group>
                </search>
            </field>
        </record>

        <record id="action_woocommerce_connection" model="ir.actions.act_window">
            <field name="name">WooCommerce Connections</field>
            <field name="res_model">woocommerce.connection</field>
            <field name="view_mode">list,form</field>
            <field name="search_view_id" ref="view_woocommerce_connection_search"/>
            <field name="context">{}</field>
            <field name="help" type="html">
                <p class="o_view_nocontent_smiling_face">
                    Create your first WooCommerce connection!
                </p>
                <p>
                    Configure your WooCommerce store connection to start importing products.
                </p>
            </field>
        </record>

    </data>
</odoo>
